<!DOCTYPE html>
<html>
<head>
    <title>شطرنج التحدي - إفناء القطع</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            gap: 0;
            border: 2px solid #333;
            background: white;
            margin: 20px;
        }

        .cell {
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .light { background: #f0d9b5; }
        .dark { background: #b58863; }

        .selected {
            box-shadow: inset 0 0 10px #4CAF50;
            transform: scale(1.1);
            z-index: 1;
        }

        .valid-move {
            background: #baca44 !important;
        }

        #controls {
            margin: 20px;
            text-align: center;
        }

        input, button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            border: 2px solid #333;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <input type="text" id="gameId" placeholder="اسم اللعبة (مثال: game1)">
        <button onclick="joinGame()">ابدأ اللعب</button>
        <div id="status">لونك: <span id="playerColor">-</span> | الدور: <span id="currentTurn">-</span></div>
    </div>
    <div id="board"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // استبدل ببيانات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyABCD...",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-bucket.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcd1234"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let gameRef;
        let playerColor = null;
        let selectedPiece = null;
        let boardState = {};

        const initialBoard = [
            ['♜','♞','♝','♛','♚','♝','♞','♜'],
            ['♟','♟','♟','♟','♟','♟','♟','♟'],
            Array(8).fill(''),
            Array(8).fill(''),
            Array(8).fill(''),
            Array(8).fill(''),
            ['♙','♙','♙','♙','♙','♙','♙','♙'],
            ['♖','♘','♗','♕','♔','♗','♘','♖']
        ];

        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for(let i = 0; i < 8; i++) {
                for(let j = 0; j < 8; j++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(i + j) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.textContent = boardState[`${i},${j}`] || '';
                    cell.onclick = () => handleClick(i, j);
                    board.appendChild(cell);
                }
            }
        }

        async function handleClick(row, col) {
            if (!playerColor || playerColor !== gameRef.currentPlayer) {
                alert("انتظر دورك!");
                return;
            }

            const piece = boardState[`${row},${col}`];
            
            if (selectedPiece) {
                if (isValidMove(selectedPiece.row, selectedPiece.col, row, col)) {
                    await makeMove(selectedPiece.row, selectedPiece.col, row, col);
                    selectedPiece = null;
                    document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected', 'valid-move'));
                }
            } else if (piece && getPieceColor(piece) === playerColor) {
                selectedPiece = { row, col };
                document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected', 'valid-move'));
                document.querySelector(`[data-row="${row}"][data-col="${col}"]`).classList.add('selected');
                showValidMoves(row, col);
            }
        }

        function isValidMove(fromRow, fromCol, toRow, toCol) {
            const piece = boardState[`${fromRow},${fromCol}`];
            const target = boardState[`${toRow},${toCol}`];
            
            if (target && getPieceColor(target) === playerColor) return false;

            if (piece === '♙') {
                const allowedForward = (fromRow - toRow === 1) && (fromCol === toCol) && !target;
                const allowedCapture = (fromRow - toRow === 1) && Math.abs(fromCol - toCol) === 1 && target;
                return allowedForward || allowedCapture;
            }
            
            if (piece === '♟') {
                const allowedForward = (toRow - fromRow === 1) && (fromCol === toCol) && !target;
                const allowedCapture = (toRow - fromRow === 1) && Math.abs(fromCol - toCol) === 1 && target;
                return allowedForward || allowedCapture;
            }
            
            return true;
        }

        async function makeMove(fromRow, fromCol, toRow, toCol) {
            boardState[`${toRow},${toCol}`] = boardState[`${fromRow},${fromCol}`];
            boardState[`${fromRow},${fromCol}`] = '';
            
            const newPlayer = playerColor === 'white' ? 'black' : 'white';
            
            await gameRef.update({
                board: boardState,
                currentPlayer: newPlayer
            });
            
            checkWinCondition();
        }

        function checkWinCondition() {
            let white = 0, black = 0;
            Object.values(boardState).forEach(piece => {
                if (piece) getPieceColor(piece) === 'white' ? white++ : black++;
            });
            
            if (white === 0) alert('الأسود فاز!');
            if (black === 0) alert('الأبيض فاز!');
        }

        function getPieceColor(piece) {
            return piece === piece.toLowerCase() ? 'black' : 'white';
        }

        async function joinGame() {
            try {
                await auth.signInAnonymously();
                
                const gameId = document.getElementById('gameId').value;
                if (!gameId) return alert('ادخل اسم اللعبة!');
                
                gameRef = db.collection('games').doc(gameId);
                
                const players = await gameRef.collection('players').get();
                if (players.size >= 2) {
                    alert('اللعبة ممتلئة!');
                    return;
                }
                
                playerColor = players.size === 0 ? 'white' : 'black';
                document.getElementById('playerColor').textContent = playerColor;
                localStorage.setItem('playerColor', playerColor);
                
                await gameRef.collection('players').doc(playerColor).set({
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                gameRef.onSnapshot(async doc => {
                    const data = doc.data();
                    if (data) {
                        boardState = data.board || {};
                        document.getElementById('currentTurn').textContent = data.currentPlayer;
                        createBoard();
                    }
                });

                if (players.size === 0) {
                    initialBoard.forEach((row, i) => {
                        row.forEach((piece, j) => {
                            boardState[`${i},${j}`] = piece;
                        });
                    });
                    await gameRef.set({
                        board: boardState,
                        currentPlayer: 'white'
                    });
                }
                
                createBoard();
            } catch (error) {
                alert(`خطأ: ${error.message}`);
            }
        }

        window.onload = () => {
            if (localStorage.getItem('playerColor')) {
                playerColor = localStorage.getItem('playerColor');
                document.getElementById('playerColor').textContent = playerColor;
            }
        };
    </script>
</body>
</html>
